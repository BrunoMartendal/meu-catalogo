<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Catálogo de Produtos</title>
    <!-- Inclui Tailwind CSS para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f8f8;
        }
        /* Estilo para o botão de loading */
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Estilo para o modal (escondido por padrão) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
            max-height: 90vh; /* Limita a altura para caber em telas menores */
            overflow-y: auto; /* Adiciona scroll se o conteúdo for muito grande */
        }
        /* Estilo para o modal de confirmação */
        .confirm-modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <header class="bg-blue-600 text-white p-4 shadow-md">
        <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-2xl font-bold mb-2 sm:mb-0">Meu Catálogo</h1>
            <div class="flex space-x-2">
                <button id="addProductButton" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center justify-center">
                    Adicionar Produto
                </button>
                <button id="refreshButton" class="bg-blue-700 hover:bg-blue-800 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center justify-center">
                    <span id="refreshText">Atualizar Produtos</span>
                    <div id="loadingSpinner" class="loading-spinner hidden ml-2"></div>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 flex-grow">
        <div id="products-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Produtos serão carregados aqui pelo JavaScript -->
        </div>
        <div id="no-products-message" class="hidden text-center text-gray-600 mt-8 text-lg">
            Nenhum produto encontrado. Clique em "Adicionar Produto" ou "Atualizar Produtos" para começar!
        </div>
    </main>

    <footer class="bg-gray-800 text-white p-4 text-center mt-auto">
        <p>&copy; 2024 Meu Catálogo. Todos os direitos reservados.</p>
    </footer>

    <!-- Modal para Adicionar/Editar Produto -->
    <div id="productModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-2xl font-bold text-gray-800 mb-6">Adicionar Novo Produto</h2>
            <form id="productForm" class="space-y-4">
                <input type="hidden" id="productId">
                <div>
                    <label for="productName" class="block text-gray-700 text-sm font-bold mb-2">Nome do Produto:</label>
                    <input type="text" id="productName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="productDescription" class="block text-gray-700 text-sm font-bold mb-2">Descrição:</label>
                    <textarea id="productDescription" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" rows="3" required></textarea>
                </div>
                <div>
                    <label for="productPrice" class="block text-gray-700 text-sm font-bold mb-2">Preço (R$):</label>
                    <input type="number" id="productPrice" step="0.01" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="productImageUrl" class="block text-gray-700 text-sm font-bold mb-2">URL da Imagem:</label>
                    <input type="url" id="productImageUrl" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="https://exemplo.com/imagem.jpg">
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancelProductButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-300 ease-in-out">Cancelar</button>
                    <button type="submit" id="saveProductButton" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 ease-in-out">Salvar Produto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div id="confirmModal" class="modal-overlay hidden">
        <div class="confirm-modal-content">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Confirmar Exclusão</h2>
            <p class="text-gray-600 mb-6">Tem certeza que deseja excluir este produto?</p>
            <div class="flex justify-center space-x-4">
                <button id="cancelDeleteButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-300 ease-in-out">Cancelar</button>
                <button id="confirmDeleteButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 ease-in-out">Excluir</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importa as funções do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, addDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais para Firebase e autenticação
        let app;
        let db;
        let auth;
        let userId;
        let products = []; // Para armazenar os produtos carregados do Firestore

        // SUAS CONFIGURAÇÕES DO FIREBASE AQUI
        const firebaseConfig = {
            apiKey: "AIzaSyAz3k-6SadhShjLPtnnGDZgL7YyLtDui7k",
            authDomain: "meu-catalogo-b5d8c.firebaseapp.com",
            projectId: "meu-catalogo-b5d8c",
            storageBucket: "meu-catalogo-b5d8c.firebasestorage.app",
            messagingSenderId: "479600983332",
            appId: "1:479600983332:web:45e59d890a87cc348247b1",
            measurementId: "G-SM6QJESRRR"
        };
        // O appId para o caminho do Firestore será o do seu firebaseConfig
        const appId = firebaseConfig.appId;
        // initialAuthToken é fornecido pelo ambiente Canvas, mantenha como está
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Elementos do DOM
        const productsContainer = document.getElementById('products-container');
        const noProductsMessage = document.getElementById('no-products-message');
        const refreshButton = document.getElementById('refreshButton');
        const refreshText = document.getElementById('refreshText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const addProductButton = document.getElementById('addProductButton');

        // Elementos do Modal de Produto
        const productModal = document.getElementById('productModal');
        const modalTitle = document.getElementById('modalTitle');
        const productForm = document.getElementById('productForm');
        // CORREÇÃO AQUI: Removido o 'document =' duplicado
        const productIdInput = document.getElementById('productId');
        const productNameInput = document.getElementById('productName');
        const productDescriptionInput = document.getElementById('productDescription');
        const productPriceInput = document.getElementById('productPrice');
        const productImageUrlInput = document.getElementById('productImageUrl');
        const cancelProductButton = document.getElementById('cancelProductButton');
        const saveProductButton = document.getElementById('saveProductButton');

        // Elementos do Modal de Confirmação
        const confirmModal = document.getElementById('confirmModal');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');
        // CORREÇÃO AQUI: ID do botão de confirmação
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        let productToDeleteId = null; // Variável para armazenar o ID do produto a ser excluído

        // --- Funções de Utilitário ---

        // Função para simular a chamada à API Gemini para gerar produtos
        async function generateProductsWithGemini(prompt) {
            console.log("Chamando Gemini para gerar produtos...");
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "id": { "type": "STRING" },
                                "name": { "type": "STRING" },
                                "description": { "type": "STRING" },
                                "price": { "type": "NUMBER" },
                                "imageUrl": { "type": "STRING" }
                            },
                            "propertyOrdering": ["id", "name", "description", "price", "imageUrl"]
                        }
                    }
                }
            };

            const apiKey = ""; // A chave API será fornecida pelo ambiente Canvas
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let retries = 0;
            const maxRetries = 5;
            const baseDelay = 1000; // 1 second

            while (retries < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) { // Too Many Requests
                            const delay = baseDelay * Math.pow(2, retries) + Math.random() * 1000; // Exponential backoff with jitter
                            console.warn(`Rate limit hit. Retrying in ${delay / 1000}s...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            retries++;
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const json = result.candidates[0].content.parts[0].text;
                        console.log("Produtos gerados pela Gemini (JSON):", json);
                        return JSON.parse(json);
                    } else {
                        console.error("Estrutura de resposta inesperada da API Gemini:", result);
                        return [];
                    }
                } catch (error) {
                    console.error("Erro ao chamar a API Gemini:", error);
                    // For network errors or other non-429 errors, retry as well
                    const delay = baseDelay * Math.pow(2, retries) + Math.random() * 1000;
                    console.warn(`Error fetching from Gemini API. Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    retries++;
                }
            }
            console.error("Máximo de tentativas de API Gemini atingido. Falha ao gerar produtos.");
            return [];
        }

        // --- Funções de Interação com Firestore ---

        // Função para adicionar ou atualizar um único produto no Firestore
        async function addOrUpdateProductToFirestore(productData) {
            console.log("Tentando salvar/atualizar produto no Firestore:", productData);
            if (!db || !userId) {
                console.error("Firestore ou userId não inicializados. Não é possível salvar produto.");
                return;
            }
            const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/products`);
            try {
                if (productData.id) {
                    // Atualiza um produto existente
                    const docRef = doc(productsCollectionRef, productData.id);
                    await setDoc(docRef, productData, { merge: true }); // merge: true para atualizar apenas os campos fornecidos
                    console.log("Produto atualizado com ID: ", productData.id);
                } else {
                    // Adiciona um novo produto (Firestore gera o ID)
                    const docRef = await addDoc(productsCollectionRef, productData);
                    console.log("Novo produto adicionado com ID: ", docRef.id);
                }
                await loadProducts(); // Recarrega os produtos após salvar
            } catch (e) {
                console.error("Erro ao salvar/atualizar produto no Firestore: ", e);
            }
        }

        // Função para salvar uma lista de produtos gerados (e.g., pela Gemini) no Firestore
        async function saveGeneratedProductsToFirestore(productsArray) {
            console.log("Tentando salvar produtos gerados no Firestore:", productsArray);
            if (!db || !userId) {
                console.error("Firestore ou userId não inicializados. Não é possível salvar produtos gerados.");
                return;
            }
            const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/products`);
            const savePromises = productsArray.map(async (product) => {
                try {
                    // Gemini fornece um 'id', então usamos setDoc com esse ID
                    const docRef = doc(productsCollectionRef, product.id);
                    await setDoc(docRef, product);
                } catch (e) {
                    console.error("Erro ao adicionar documento gerado no Firestore: ", e);
                }
            });
            await Promise.all(savePromises); // Aguarda todos os saves serem concluídos
            console.log("Todos os produtos gerados foram processados para salvar no Firestore.");
        }

        // Função para carregar produtos do Firestore
        async function loadProductsFromFirestore() {
            console.log("Tentando carregar produtos do Firestore...");
            if (!db || !userId) {
                console.error("Firestore ou userId não inicializados. Não é possível carregar produtos.");
                return [];
            }
            const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/products`);
            const loadedProducts = [];
            try {
                const querySnapshot = await getDocs(productsCollectionRef);
                querySnapshot.forEach((doc) => {
                    loadedProducts.push({ id: doc.id, ...doc.data() });
                });
                console.log("Produtos carregados do Firestore:", loadedProducts);
            } catch (e) {
                console.error("Erro ao carregar documentos do Firestore: ", e);
            }
            return loadedProducts;
        }

        // Função para excluir um produto do Firestore
        async function deleteProductFromFirestore(productId) {
            console.log("Tentando excluir produto do Firestore com ID:", productId);
            if (!db || !userId) {
                console.error("Firestore ou userId não inicializados. Não é possível excluir produto.");
                return;
            }
            const productDocRef = doc(db, `artifacts/${appId}/users/${userId}/products`, productId);
            try {
                await deleteDoc(productDocRef);
                console.log("Produto excluído com ID: ", productId);
                await loadProducts(); // Recarrega os produtos após excluir
            } catch (e) {
                console.error("Erro ao excluir produto do Firestore: ", e);
            }
        }

        // --- Funções de UI ---

        // Função para renderizar os produtos na página
        function renderProducts(productsToRender) {
            console.log("Renderizando produtos:", productsToRender);
            productsContainer.innerHTML = ''; // Limpa o container antes de adicionar novos produtos
            if (productsToRender.length === 0) {
                noProductsMessage.classList.remove('hidden');
                return;
            }
            noProductsMessage.classList.add('hidden');

            productsToRender.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'bg-white rounded-lg shadow-lg overflow-hidden transform transition duration-300 hover:scale-105';
                productCard.innerHTML = `
                    <img src="${product.imageUrl || 'https://placehold.co/400x300/e0e0e0/ffffff?text=Produto'}" alt="${product.name}" class="w-full h-48 object-cover object-center" onerror="this.onerror=null;this.src='https://placehold.co/400x300/e0e0e0/ffffff?text=Produto';">
                    <div class="p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-2">${product.name}</h2>
                        <p class="text-gray-600 text-sm mb-4">${product.description}</p>
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-2xl font-bold text-blue-600">R$ ${product.price ? product.price.toFixed(2).replace('.', ',') : '0,00'}</span>
                        </div>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                            <button class="share-button bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg w-full sm:w-auto transition duration-300 ease-in-out"
                                    data-name="${product.name}"
                                    data-description="${product.description}"
                                    data-price="${product.price ? product.price.toFixed(2).replace('.', ',') : '0,00'}">
                                Compartilhar no WhatsApp
                            </button>
                            <button class="edit-button bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg w-full sm:w-auto transition duration-300 ease-in-out"
                                    data-id="${product.id}">
                                Editar
                            </button>
                            <button class="delete-button bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg w-full sm:w-auto transition duration-300 ease-in-out"
                                    data-id="${product.id}">
                                Excluir
                            </button>
                        </div>
                    </div>
                `;
                productsContainer.appendChild(productCard);
            });

            // Adiciona event listeners aos botões de compartilhamento, edição e exclusão
            document.querySelectorAll('.share-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const name = event.target.dataset.name;
                    const description = event.target.dataset.description;
                    const price = event.target.dataset.price;
                    const message = `Confira este produto:\n\n*${name}*\n${description}\n*Preço: R$ ${price}*\n\n#MeuCatalogo`;
                    const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
                    window.open(whatsappUrl, '_blank');
                });
            });

            document.querySelectorAll('.edit-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const productId = event.target.dataset.id;
                    const productToEdit = products.find(p => p.id === productId);
                    if (productToEdit) {
                        openProductModal(productToEdit);
                    }
                });
            });

            document.querySelectorAll('.delete-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    productToDeleteId = event.target.dataset.id;
                    confirmModal.classList.remove('hidden');
                });
            });
        }

        // Abre o modal de produto (para adicionar ou editar)
        function openProductModal(product = null) {
            productForm.reset(); // Limpa o formulário
            productIdInput.value = ''; // Limpa o ID oculto

            if (product) {
                modalTitle.textContent = 'Editar Produto';
                productIdInput.value = product.id;
                productNameInput.value = product.name;
                productDescriptionInput.value = product.description;
                productPriceInput.value = product.price;
                productImageUrlInput.value = product.imageUrl || '';
            } else {
                modalTitle.textContent = 'Adicionar Novo Produto';
            }
            productModal.classList.remove('hidden');
            console.log("Modal de produto aberto.");
        }

        // Fecha o modal de produto
        function closeProductModal() {
            productModal.classList.add('hidden');
            productForm.reset();
            console.log("Modal de produto fechado.");
        }

        // --- Funções Principais ---

        // Carrega os produtos (do Firestore ou gera com Gemini se vazio)
        async function loadProducts() {
            console.log("Iniciando loadProducts...");
            refreshText.textContent = 'Carregando...';
            loadingSpinner.classList.remove('hidden');
            refreshButton.disabled = true;

            products = await loadProductsFromFirestore(); // Carrega do Firestore

            if (products.length === 0) {
                console.log("Nenhum produto encontrado no Firestore. Tentando gerar com Gemini...");
                const prompt = `Gere uma lista de 6 produtos populares para um catálogo online. Cada produto deve ter um 'id' único (string), 'name' (string), 'description' (string curta), 'price' (número) e 'imageUrl' (string de URL de placeholder ou genérica). Exemplo de formato: [{"id": "prod1", "name": "Produto A", "description": "Descrição do Produto A", "price": 29.99, "imageUrl": "https://placehold.co/400x300/e0e0e0/ffffff?text=Produto+A"}]. As imagens podem ser URLs de placeholder como 'https://placehold.co/400x300/e0e0e0/ffffff?text=Produto'.`;
                const generatedProducts = await generateProductsWithGemini(prompt);
                if (generatedProducts.length > 0) {
                    await saveGeneratedProductsToFirestore(generatedProducts); // Salva os produtos gerados no Firestore
                    products = generatedProducts; // Atualiza a lista local com os produtos gerados
                }
            }

            renderProducts(products);
            console.log("LoadProducts concluído.");

            refreshText.textContent = 'Atualizar Produtos';
            loadingSpinner.classList.add('hidden');
            refreshButton.disabled = false;
        }

        // --- Inicialização e Event Listeners ---

        // Inicializa o Firebase e carrega/gera produtos
        async function initializeFirebaseAndLoadProducts() {
            console.log("Iniciando initializeFirebaseAndLoadProducts...");
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase inicializado.");

                // Autentica o usuário e carrega produtos APÓS autenticação
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Usuário autenticado:", userId);
                        await loadProducts(); // Carrega produtos APÓS userId estar garantido
                    } else {
                        console.log("Nenhum usuário autenticado. Tentando login anônimo...");
                        // Se não houver usuário, tenta login anônimo
                        if (!initialAuthToken) {
                            await signInAnonymously(auth);
                            // onAuthStateChanged será chamado novamente com o usuário anônimo
                        } else {
                            // Se houver token inicial mas o usuário ainda não está logado, tenta com o token
                            await signInWithCustomToken(auth, initialAuthToken);
                            // onAuthStateChanged será chamado novamente com o usuário do token
                        }
                        // Se ainda não houver user (e.g., token inválido ou erro), renderiza vazio
                        if (!auth.currentUser) {
                            console.error("Não foi possível obter um userId após tentativas de autenticação. Não carregando produtos.");
                            renderProducts([]);
                            refreshText.textContent = 'Erro ao carregar';
                            loadingSpinner.classList.add('hidden');
                            refreshButton.disabled = false;
                        }
                    }
                });

            } catch (error) {
                console.error("Erro ao inicializar Firebase ou autenticar:", error);
                renderProducts([]); // Renderiza vazio em caso de erro grave
                refreshText.textContent = 'Erro ao carregar';
                loadingSpinner.classList.add('hidden');
                refreshButton.disabled = false;
            }
        }

        // Event listener para o botão "Adicionar Produto"
        addProductButton.addEventListener('click', () => {
            console.log("Botão 'Adicionar Produto' clicado.");
            openProductModal();
        });

        // Event listener para o botão "Cancelar" no modal de produto
        cancelProductButton.addEventListener('click', () => {
            console.log("Botão 'Cancelar' clicado no modal.");
            closeProductModal();
        });

        // Event listener para o envio do formulário no modal de produto
        productForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // Impede o recarregamento da página
            console.log("Formulário de produto enviado.");

            const id = productIdInput.value;
            const name = productNameInput.value.trim();
            const description = productDescriptionInput.value.trim();
            const price = parseFloat(productPriceInput.value);
            const imageUrl = productImageUrlInput.value.trim();

            if (!name || !description || isNaN(price)) {
                console.error("Por favor, preencha todos os campos obrigatórios (Nome, Descrição, Preço).");
                return;
            }

            const productData = { name, description, price, imageUrl };
            if (id) {
                productData.id = id; // Se for edição, mantém o ID existente
            }
            console.log("Dados do produto a serem salvos:", productData);

            await addOrUpdateProductToFirestore(productData); // Adiciona/atualiza no Firestore
            closeProductModal(); // Fecha o modal após salvar
        });

        // Event listener para o botão "Atualizar Produtos" (recarrega do Firestore ou gera novos)
        refreshButton.addEventListener('click', async () => {
            console.log("Botão 'Atualizar Produtos' clicado.");
            // Limpa os produtos existentes antes de gerar novos
            productsContainer.innerHTML = '';
            noProductsMessage.classList.add('hidden');
            refreshText.textContent = 'Gerando novos...';
            loadingSpinner.classList.remove('hidden');
            refreshButton.disabled = true;

            // Gera novos produtos com a API Gemini
            const prompt = `Gere uma lista de 6 produtos populares e diferentes dos anteriores para um catálogo online. Cada produto deve ter um 'id' único (string), 'name' (string), 'description' (string curta), 'price' (número) e 'imageUrl' (string de URL de placeholder ou genérica). Exemplo de formato: [{"id": "prod1", "name": "Produto A", "description": "Descrição do Produto A", "price": 29.99, "imageUrl": "https://placehold.co/400x300/e0e0e0/ffffff?text=Produto+A"}]. As imagens podem ser URLs de placeholder como 'https://placehold.co/400x300/e0e0e0/ffffff?text=Produto'.`;
            const newProducts = await generateProductsWithGemini(prompt);

            if (newProducts.length > 0) {
                // Remove os produtos antigos do Firestore antes de salvar os novos
                const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/products`);
                const querySnapshot = await getDocs(productsCollectionRef);
                // Aguarda todas as exclusões antes de adicionar os novos
                console.log("Removendo produtos antigos do Firestore...");
                await Promise.all(querySnapshot.docs.map(doc => deleteDoc(doc.ref)));
                console.log("Produtos antigos removidos.");

                // Salva os novos produtos gerados
                await saveGeneratedProductsToFirestore(newProducts);
                products = newProducts; // Atualiza a lista local com os produtos recém-gerados
            } else {
                products = []; // Se não gerou nada, esvazia a lista local
            }
            renderProducts(products); // Renderiza os produtos (recém-gerados ou vazios)

            refreshText.textContent = 'Atualizar Produtos';
            loadingSpinner.classList.add('hidden');
            refreshButton.disabled = false;
            console.log("Processo de atualização de produtos concluído.");
        });

        // Inicia a aplicação quando a janela estiver totalmente carregada
        window.onload = initializeFirebaseAndLoadProducts;
    </script>
</body>
</html>
